" for vimperator hg head

" prefs
" ======================================================================
" ダウンロードマネージャを表示しない
set! browser.download.manager.showWhenStarting=false

" 最後のタブを閉じたときに Firefox を終了しない
set! browser.tabs.closeWindowWithLastTab=false

" ページのアクセスキーを無効化
set! ui.key.generalAccessKey=0

" Awesomebarの補完対象にBookmarkletを含める&件数を変更
set! browser.urlbar.filter.javascript=false
set! browser.urlbar.maxRichResults=20

" ポップアップ許可数を拡張 cf.http://la.ma.la/blog/diary_200611171115.htm
set! dom.popup_maximum=9999

" Gmail/LDR/Fastladder/OpenFL/はてブでは新規タブをバックグラウンドで開く
" autocmd LocationChange '^(?!https?://(mail\.google\.com\/(mail|a)\/|(reader\.livedoor\.com|fastladder\.com|0\.0\.0\.0\:3000)/reader/|b\.hatena\.ne\.jp/(?!(entry|articles|guide))))' :set! browser.tabs.loadDivertedInBackground=false
" autocmd LocationChange '^https?://(mail\.google\.com\/(mail|a)\/|(reader\.livedoor\.com|fastladder\.com|0\.0\.0\.0\:3000)/reader/|b\.hatena\.ne\.jp/(?!(entry|articles|guide)))' :set! browser.tabs.loadDivertedInBackground=true

" options
" ======================================================================
" GUI
set gui=none,tabs

" ヒントの文字列をアルファベットに
set hintchars=hjklasdfg

" /,? 検索結果をハイライト
set hlsearch

" :[tab]open の補完対象と順番
set complete=tsl

" ページロード時にテキストボックスにフォーカスするのを防ぐ
set focuscontent

" Beep設定
set visualbell
hi Bell display: none;

" add strings for hitting]]/[[
set nextpattern+=次ページ,次のページ,\b次.*,\b→,old
set previouspattern+=prev, 前ページ,前のページ,\b前.*,\b→,new

" Mappings
" ======================================================================
" OSのキーバインドを再現
inoremap <C-f> <Right>
inoremap <C-b> <Left>
inoremap <C-p> <Up>
inoremap <C-n> <Down>
inoremap <C-h> <BS>
inoremap <C-d> <DEL>
cnoremap <C-f> <Right>
cnoremap <C-b> <Left>
cnoremap <C-p> <Up>
cnoremap <C-n> <Down>
cnoremap <C-h> <BS>
cnoremap <C-d> <DEL>

nnoremap <C-i> <Tab>
nnoremap <C-[> <ESC>

" undo一覧から開く
nnoremap U :undo<Space>

" ブラウザ再起動
nnoremap <C-r> :restart<CR>

" j/k でページダウン/アップ
nnoremap j 3j
nnoremap k 3k

" 上のディレクトリに移動
nnoremap <BS> gu
nnoremap <C-BS> gU

" タブ順序変更
nnoremap <C-h> :tabmove! -1<CR>
nnoremap <C-l> :tabmove! +1<CR>

" h/l で タブ移動
nnoremap h <C-p>
nnoremap l <C-n>

" J/K をC-d/u互換に
nnoremap J <C-d>
nnoremap K <C-u>

" タブを閉じたら左のタブを表示
nnoremap d D
nnoremap D d

" buffer
nnoremap . b

" search
noremap <M-f> /

" qmark
nnoremap m :qmark<Space>
nnoremap M :qmarks<CR>

" ex mode で C-n/p
cnoremap <C-n> <Tab>
cnoremap <C-p> <S-Tab>

" ++/-- numbers in URL
noremap ++ <C-a>
noremap -- <C-x>

" ! でページのCSSをon/off
nnoremap ! :set invum<CR>

" visual modeで選択したテキストを検索
vnoremap P y<Esc><Esc>P

" ex modeでC-jを無効化
cnoremap <C-j> <Nop>

" i で caret-mode
nnoremap i caret-mode

" command
" ======================================================================
" autocmd VimperatorEnter .* <args> を lazy コマンドとして登録
command! -nargs=+ lazy autocmd VimperatorEnter .* <args>
command clip echo RIL.addCurrent() !== false ? 'Success' : 'Failed (or alread clipped?)'

" Plugins
" ======================================================================
" plugin_loader.js
let g:plugin_loader_roots = "~/src/vimperator-plugins/ ~/Documents/repos/vimperator-plugins/"
let g:plugin_loader_plugins = "_libly,appendAnchor,auto_detect_link,auto-focus-frame,auto_word_select_mode,caret-hint,copy,direct_bookmark,feedSomeKeys_3,hatenaStar,multi_requester,pino,sbmcommentsviewer,tombloo,walk-input,stella,opener,statusline-toolbar,migemo_completion,lo,auto-bookmark,slideshare"

" caret-hint
let g:caret_hint_key = "i"
let g:caret_hint_tail_key = "I"
let g:caret_hint_select_key = "v"
let g:caret_hint_select_tail_key = "V"
let g:caret_hint_swap_key = "s"

" appendAnchor.js
let g:auto_append_anchor = "true"
let g:auto_append_anchor_once = "true"

" sbmcommentsviewer.js
let g:def_sbm_format = "id,tags,comment,timestamp"
let g:def_sbms = "h"
nnoremap b :viewSBMComments<CR>
color sbmcommentsviewer

" direct_bookmark.js
let g:direct_sbm_use_servicesy_tag = "hd"
let g:direct_sbm_use_services_by_post = "hd"
" let g:direct_sbm_is_normalize = "false"
let g:direct_sbm_is_use_migemo = "true"
nnoremap B :bentry<CR>
map a :sbm<Space>
lazy :btags

" multi_requester
nnoremap ,m :mr<Space>
nnoremap ma :mr alc<Space>
nnoremap mt :mr googletrans-ja<Space>
nnoremap mT :mr googletrans-ja<CR>

" copy.js
nnoremap c :copy<space>
js <<EOM
liberator.globalVariables.copy_templates = [
  { label: 'titleAndURL',    value: '%TITLE% %URL%' },
  { label: 'title',          value: '%TITLE%' },
  { label: 'url',            value: '%URL%' },
  { label: 'markdown',       value: '[%TITLE%](%URL% "%TITLE%")' },
  { label: 'markdownsel',    value: '[%SEL%](%URL% "%TITLE%")' },
  { label: 'htmlblockquote', value: '<blockquote cite="%URL%" title="%TITLE%">%HTMLSEL%</blockquote>' }
];
EOM

" stella
js <<EOM
function addLocalMappings(buffer, maps) {
  maps.forEach(
    function (map) {
      let [cmd, action, extra] = map;
      let actionFunc = action;
      extra || (extra = {});

      if (typeof action == "string") {
        if (action.charAt(0) == ':')
          actionFunc = extra.open ? function () commandline.open("", action, modes.EX)
                                  : function () liberator.execute(action);
        else
          actionFunc = function () events.feedkeys(action, extra.noremap, true);
      }
      extra.matchingUrls = buffer;
      mappings.addUserMap(
        [modes.NORMAL],
        [cmd],
        "Local mapping for " + buffer,
        actionFunc,
        extra
      );
    }
  );
}
addLocalMappings(
  /^(http:\/\/(es|www).nicovideo.jp\/(watch|playlist\/mylist)|http:\/\/(jp|www)\.youtube\.com\/watch|http:\/\/(www\.)?vimeo\.com\/(channels\/(hd)?#)?\d+)/,
  [
    ['<C-g>', ':pageinfo S', ],
    ['p', ':stplay', ],
    ['m', ':stmute', ],
    [',c', ':stcomment', ],
    ['zz', ':stlarge', ],
    ['r', ':strepeat', ],
    ['+', ':stvolume! 10', ],
    ['-', ':stvolume! -10', ],
    ['<', ':stseek! -10', ],
    ['>', ':stseek! 10', ],
    ['v', ':stvolume ', {open: true}],
    ['V', ':stvolume! ', {open: true}],
    ['o', ':strelations ', {open: true}],
    ['O', ':strelations! ', {open: true}],
  ]
);
EOM

" feedSomeKeys_3.js
lazy fmaps -u='^https?://mail\.google\.com/(mail|a)/' c j k n p o u e x s r a # [ ] z ? I U gi gs gt gd ga gc gk gl *a *n *r *u *s *t
" lazy fmaps -u='^https?://www\.google\.com/calendar/' c e j k n p r t d w m x a <BS> ?
lazy fmaps -u='^http://b\.hatena\.ne\.jp/(?!(entry|articles|guide))' j k o,oj e a,b
lazy fmaps -e=vkeydown -u='^http://www\.tumblr\.com/' j k r,h q p n L,l <S-e>
lazy fmaps -u='^http://reader\.livedoor\.com/reader/' j k s a p v z <S-z> ,r,r < > o,vj J,<Space> K,<S-Space> q w g
lazy fmaps -u='www\.feedly\.com' g h m a e t c d p l s n b n p o v V m s S D e t d c / r ? 1 2 3 4 5 6 7 8 9 <Enter>
nnoremap -u='^http://reader\.livedoor\.com/reader/' b :tombloo Link - LDR<CR>
nnoremap -u='^http://reader\.livedoor\.com/reader/' B :tombloo! Link - LDR<CR>
nnoremap -u='^http://reader\.livedoor\.com/reader/' e :tombloo ReBlog - LDR<CR>

" multi_requester
javascript <<EOM
liberator.globalVariables.multi_requester_siteinfo = [
  {
    name: 'yahoo-transit',
    description: 'Yahoo 路線情報',
    url: 'http://transit.loco.yahoo.co.jp/search/result?flatlon=&from=%s&tlatlon=&to=%s&via=&shin=1&ex=1&al=1&hb=1&lb=1&sr=1&expkind=1&ym=201306&d=05&datepicker=&hh=10&m1=5&m2=0&type=1&ws=2&s=0&x=0&y=0',
    xpath: 'id("main")',
  },
];
liberator.globalVariables.multi_requester_mappings = [
  [ ",myr", "yahoo-transit" ],
];
EOM

" slideshare
nnoremap -urls=www\\.slideshare\\.net n :slideshare next<CR>
nnoremap -urls=www\\.slideshare\\.net p :slideshare prev<CR>

" javascript
" ======================================================================

" Firefoxのタブを開く位置をデフォで現在のタブの右隣にする（※ gBrowser.addTabの改造）
" cf.http://d.hatena.ne.jp/wlt/20110112/1294859530
js <<EOM
gBrowser.addTab = liberator.eval(
    '(' +
    gBrowser.addTab.toSource()
            .replace(/var\s*aRelatedToCurrent;/, 'var aRelatedToCurrent = true;')
            .replace(/aRelatedToCurrent\s*=\s*params\.relatedToCurrent;/, 'aRelatedToCurrent = params.relatedToCurrent === undefined ? true : params.relatedToCurrent;') +
    ')',
    gBrowser.addTab);
EOM

" autocmd 駆動時のエコーをやめる
" cf.http://vimperator.g.hatena.ne.jp/nokturnalmortum/20110616/1308191737
js <<EOM
let (original = liberator.echomsg)
  liberator.echomsg = function (msg) {
    const REAC = RegExp('-> liberator://template/chrome://liberator/content/as\\.js:\\d+');
    if (Error().stack.split(/\n/).some(RegExp.prototype.test.bind(REAC)) && /Executing .* Auto commands for .*/.test(msg))
      liberator.log(msg);
    else
      original.apply(liberator, arguments);
  };
EOM

" ステータスバーにfeedボタンを表示
js <<EOM
(function(){
 var feedPanel = document.createElement('statusbarpanel');
 var feedButton = document.getElementById('feed-button');
 feedPanel.setAttribute('id','feed-panel-clone');
 feedPanel.appendChild(feedButton.cloneNode(true));
 feedButton.parentNode.removeChild(feedButton);
 document.getElementById('status-bar').insertBefore(feedPanel,document.getElementById('security-button'));
})();
EOM

" Firebug
" cf.http://d.hatena.ne.jp/zentoo/20111009/1318148524
" firebug inspect mode hint
js <<EOM
hints.addMode('n', 'firebug inspect hint', function(elem){
    Firebug.toggleBar(true);
    Firebug.chrome.select(elem);
}, function() '//*');
EOM
" contenteditable hint
js <<EOM
hints.addMode('e', 'contenteditable hint', function(elem){
    elem.setAttribute("contenteditable", true);
    elem.focus();
}, function() '//*');
EOM

" qmarks
" ======================================================================
silent qmark c http://www.google.com/calendar/
silent qmark d http://delicious.com/bonty.shushusha
silent qmark g https://mail.google.com/
silent qmark f http://www.facebook.com/
silent qmark h http://b.hatena.ne.jp/bonty_shushusha/
silent qmark l http://reader.livedoor.com/reader/
silent qmark m http://maps.google.co.jp/
silent qmark n http://www.nicovideo.jp/
silent qmark p http://www.flickr.com/
silent qmark t http://twitter.com/
silent qmark y http://jp.youtube.com/
silent qmark T http://www.tumblr.com/dashboard

" style
" ======================================================================
color hint

" toolbarbutton
style -name toolbarbutton-feed-icon chrome://* #liberator-customize-toolbar > #feed-button { -moz-appearance: none !important; }

" ex mode時IMEをOFF
style -name commandline-ime chrome://* #liberator-commandline-command input { ime-mode: inactive; }

colorscheme abyss

echo 'get smart!'

" vim: set ft=vimperator:
