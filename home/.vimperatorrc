" for vimperator hg head

" prefs
" ======================================================================
" ダウンロードマネージャを表示しない
set! browser.download.manager.showWhenStarting=false
set! browser.download.manager.retention=1

" 最後のタブを閉じたときに Firefox を終了しない
set! browser.tabs.closeWindowWithLastTab=false

" ページのアクセスキーを無効化
set! ui.key.generalAccessKey=0

" options
" ======================================================================
" GUI
set gui=none,tabs

" ヒントの文字列をアルファベットに
set hintchars=aoeuidhtns

" /,? 検索結果をハイライト
set hlsearch

" :[tab]open の補完対象と順番
set complete=tsl

" ページロード時にテキストボックスにフォーカスするのを防ぐ
set focuscontent

" Beep設定
set visualbell
hi Bell display:none

" IME off at command mode
style! -name=commandline-ime chrome://* #liberator-commandline-command input {ime-mode: inactive;}

" add strings for hitting]]/[[
set nextpattern+=次ページ,次のページ,\b次.*,\b→,old
set previouspattern+=prev, 前ページ,前のページ,\b前.*,\b→,new

" Mappings
" ======================================================================
" map at dvorak
nnoremap h 5j
nnoremap t 5k
nnoremap H <C-d>
nnoremap T <C-u>

nnoremap d <C-p>
nnoremap n <C-n>
nnoremap D H
nnoremap N L
nnoremap <C-d> :tabmove! -1<CR>
nnoremap <C-n> :tabmove! +1<CR>

nnoremap e D
nnoremap E d

nnoremap . b

nnoremap b n
nnoremap B N

nnoremap y t
nnoremap Y T

nnoremap U :undo<Space>

nnoremap <C-r> :restart<CR>

nnoremap <BS> H

" ex mode で C-n/p
cnoremap <C-n> <Tab>
cnoremap <C-p> <S-Tab>

" ++/-- numbers in URL
noremap ++ <C-a>
noremap -- <C-x>

" i で caret-mode
nnoremap i caret-mode

" visual modeで選択したテキストを検索
vnoremap P y<Esc><Esc>P


" " OSのキーバインドを再現
" inoremap <C-f> <Right>
" inoremap <C-b> <Left>
" inoremap <C-p> <Up>
" inoremap <C-n> <Down>
" inoremap <C-h> <BS>
" inoremap <C-d> <DEL>
" cnoremap <C-f> <Right>
" cnoremap <C-b> <Left>
" cnoremap <C-p> <Up>
" cnoremap <C-n> <Down>
" cnoremap <C-h> <BS>
" cnoremap <C-d> <DEL>

" nnoremap <C-i> <Tab>
" nnoremap <C-[> <ESC>


" command
" ======================================================================
" autocmd VimperatorEnter .* <args> を lazy コマンドとして登録
command! -nargs=+ lazy autocmd VimperatorEnter .* <args>
command clip echo RIL.addCurrent() !== false ? 'Success' : 'Failed (or alread clipped?)'

" Plugins
" ======================================================================
" plugin_loader.js
let g:plugin_loader_roots = "~/src/vimperator-plugins/ ~/Documents/repos/vimperator-plugins/"
let g:plugin_loader_plugins = "_libly,appendAnchor,auto_detect_link,auto-focus-frame,copy,feedSomeKeys_3,multi_requester,sbmcommentsviewer,walk-input,stella,opener"

" appendAnchor.js
let g:auto_append_anchor = "true"
let g:auto_append_anchor_once = "true"

" sbmcommentsviewer.js
let g:def_sbm_format = "id,comment"
let g:def_sbms = "h"
nnoremap v :viewSBMComments<CR>

" multi_requester
nnoremap mu :mr<Space>
nnoremap ma :mr alc<Space>
nnoremap mt :mr googletrans-ja<Space>

" copy.js
nnoremap c y
nnoremap C :copy<space>
js <<EOM
liberator.globalVariables.copy_templates = [
  { label: 'titleAndURL',    value: '%TITLE% %URL%' },
  { label: 'markdown',       value: '[%TITLE%](%URL% "%TITLE%")' },
  { label: 'markdownsel',    value: '[%SEL%](%URL% "%TITLE%")' }
];
EOM

" stella
js <<EOM
function addLocalMappings(buffer, maps) {
  maps.forEach(
    function (map) {
      let [cmd, action, extra] = map;
      let actionFunc = action;
      extra || (extra = {});

      if (typeof action == "string") {
        if (action.charAt(0) == ':')
          actionFunc = extra.open ? function () commandline.open("", action, modes.EX)
                                  : function () liberator.execute(action);
        else
          actionFunc = function () events.feedkeys(action, extra.noremap, true);
      }
      extra.matchingUrls = buffer;
      mappings.addUserMap(
        [modes.NORMAL],
        [cmd],
        "Local mapping for " + buffer,
        actionFunc,
        extra
      );
    }
  );
}
addLocalMappings(
  /^(http:\/\/(es|www).nicovideo.jp\/(watch|playlist\/mylist)|http:\/\/(jp|www)\.youtube\.com\/watch|http:\/\/(www\.)?vimeo\.com\/(channels\/(hd)?#)?\d+)/,
  [
    ['<C-g>', ':pageinfo S', ],
    ['p', ':stplay', ],
    ['m', ':stmute', ],
    [',c', ':stcomment', ],
    ['zz', ':stlarge', ],
    ['r', ':strepeat', ],
    ['+', ':stvolume! 10', ],
    ['-', ':stvolume! -10', ],
    ['<', ':stseek! -10', ],
    ['>', ':stseek! 10', ],
    ['v', ':stvolume ', {open: true}],
    ['V', ':stvolume! ', {open: true}],
    ['o', ':strelations ', {open: true}],
    ['O', ':strelations! ', {open: true}],
  ]
);
EOM

" feedSomeKeys_3.js
lazy fmaps -u='^https?://mail\.google\.com/(mail|a)/' c j k n p o u e x s r a # [ ] z ? I U gi gs gt gd ga gc gk gl *a *n *r *u *s *t
" lazy fmaps -u='^https?://www\.google\.com/calendar/' c e j k n p r t d w m x a <BS> ?
lazy fmaps -u='^http://b\.hatena\.ne\.jp/(?!(entry|articles|guide))' j k o,oj e a,b
lazy fmaps -e=vkeydown -u='^http://www\.tumblr\.com/' j k r,h q p n L,l <S-e>
lazy fmaps -u='www\.feedly\.com' g h m a e t c d p l s n b n p o v V m s S D e t d c / r ? 1 2 3 4 5 6 7 8 9 <Enter>

" javascript
" ======================================================================

" Firefoxのタブを開く位置をデフォで現在のタブの右隣にする（※ gBrowser.addTabの改造）
" cf.http://d.hatena.ne.jp/wlt/20110112/1294859530
js <<EOM
gBrowser.addTab = liberator.eval(
    '(' +
    gBrowser.addTab.toSource()
            .replace(/var\s*aRelatedToCurrent;/, 'var aRelatedToCurrent = true;')
            .replace(/aRelatedToCurrent\s*=\s*params\.relatedToCurrent;/, 'aRelatedToCurrent = params.relatedToCurrent === undefined ? true : params.relatedToCurrent;') +
    ')',
    gBrowser.addTab);
EOM

" autocmd 駆動時のエコーをやめる
" cf.http://vimperator.g.hatena.ne.jp/nokturnalmortum/20110616/1308191737
js <<EOM
let (original = liberator.echomsg)
  liberator.echomsg = function (msg) {
    const REAC = RegExp('-> liberator://template/chrome://liberator/content/as\\.js:\\d+');
    if (Error().stack.split(/\n/).some(RegExp.prototype.test.bind(REAC)) && /Executing .* Auto commands for .*/.test(msg))
      liberator.log(msg);
    else
      original.apply(liberator, arguments);
  };
EOM

" qmarks
" ======================================================================
silent qmark c http://www.google.com/calendar/
silent qmark g https://mail.google.com/
silent qmark f http://www.facebook.com/

" style
" ======================================================================
color hint
colorscheme abyss

hi Hint font-family: Arial; font-size: 21px; font-weight: bold; text-shadow: -1px -1px 2px black, 1px -1px 2px black, -1px 1px 2px black, 1px 1px 2px black; color: #33cccc;
hi HintElem color: gray; background-color: #a1e4e6;
hi HintActive color: black; background-color: #ff8700;
